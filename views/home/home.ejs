<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link rel="stylesheet" href="/homestyle.css" />
  </head>
  <body>
    <div class="container">
      <form
        id="searchForm"
        class="form"
        action="javascript:void(0)"
        method="post"
      >
        <input id="searchInput" type="text" name="search" value="" />
        <input id="searchButton" type="submit" value="Search" />
      </form>
    </div>
    <div id="logoutContainer" class="container">
      <form class="form" action="/home/logout" method="post">
        <input id="logoutButton" type="submit" value="Logout" />
      </form>
    </div>
    <div class="usernameContainer">
      <p>Username: <%= userData.username %></p>
    </div>
    <div class="mainContainer">
      <div class="leftContainer">
        <% linkedConcerts.forEach(function(linkedConcert) { %> <% if
        (linkedConcert.userId === userData.id) { %>
        <!-- Update the condition to use userData.id -->
        <p><%= linkedConcert.Concert.name %></p>
        <% } %> <% }); %>
      </div>

      <div class="rightContainer">
        <% concerts.forEach(function(concert) { %>
        <div>
          <h2><%= concert.concert.name %></h2>
          <% concert.associatedUsernames.forEach(function(username) { %>
          <p>Username: <%= username %></p>
          <% }); %>
        </div>
        <% }); %>
      </div>
      <div id="searchResultsContainer" class="searchResultsContainer"></div>
      <div id="paginationContainer" style="text-align: center">
        <button id="previousButton" style="margin-right: 5px; display: none">
          Previous
        </button>
        <button id="nextButton" style="margin-left: 5px; display: none">
          Next
        </button>
      </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
      $(document).ready(function () {
        var currentPage = 0;
        var pageSize = 10;
        var totalResults = 0;

        // Attach an event listener to the search button
        $("#searchForm").submit(function (event) {
          event.preventDefault(); // Prevent form submission

          var searchKeyword = $("#searchInput").val();
          currentPage = 0; // Reset current page when performing a new search
          searchEvents(searchKeyword);
        });

        // Attach an event listener to the "Previous" button
        $("#previousButton").click(function () {
          currentPage--;
          var searchKeyword = $("#searchInput").val();
          searchEvents(searchKeyword);
        });

        // Attach an event listener to the "Next" button
        $("#nextButton").click(function () {
          currentPage++;
          var searchKeyword = $("#searchInput").val();
          searchEvents(searchKeyword);
        });

        function searchEvents(keyword) {
          $.ajax({
            type: "GET",
            url: "https://app.ticketmaster.com/discovery/v2/events.json",
            async: true,
            dataType: "json",
            data: {
              keyword: keyword,
              page: currentPage,
              size: pageSize,
              sort: "date,asc", // Sort by date in ascending order
              apikey: "83FaiAZhCP41A21Ku8BCVMDVxlV9UOO8",
              // Add other query parameters as needed
            },
            success: function (json) {
              console.log(json._embedded.events);
              totalResults = json.page.totalElements;
              // Parse the response and handle the search results
              displaySearchResults(json._embedded.events);
            },
            error: function (xhr, status, err) {
              console.error(err);
              // Handle the error case
            },
          });
        }

        function displaySearchResults(events) {
          var searchResultsContainer = $("#searchResultsContainer");

          // Clear previous search results if it's the first page
          if (currentPage === 0) {
            searchResultsContainer.empty();
          }

          // Loop through the events and create the HTML for each result
          events.forEach(function (event) {
            var resultElement = $("<div>")
              .addClass("searchResult")
              .hide() // Hide the result initially
              .append($("<h2>").text(event.name))
              .append($("<p>").text("Date: " + event.dates.start.localDate))
              .append($("<p>").text("ID: " + event.id))
              .append($("<a>").attr("href", event.url).text("View Details"))
              .append(
                $("<button>").text("Add Concert").addClass("addConcertButton")
              )
              .data("concert", {
                concertCode: event.id,
                name: event.name,
                date: event.dates.start.localDate,
                url: event.url,
              });

            searchResultsContainer.append(resultElement);

            // Use a timeout to gradually show the result with the fade-in animation
            setTimeout(function () {
              resultElement.addClass("loaded").show();
            }, 100 * (searchResultsContainer.children().length - 1));
          });

          // Show/hide the "Previous" and "Next" buttons based on the current page
          $("#previousButton").toggle(currentPage > 0);
          $("#nextButton").toggle((currentPage + 1) * pageSize < totalResults);

          // Attach event listener to the "Add Concert" button
          $(document).on("click", ".addConcertButton", function () {
            var concertData = $(this).closest(".searchResult").data("concert");

            // Make a POST request to the "/new_concert" route with the concert data
            $.ajax({
              url: "./concerts/new_concert",
              method: "POST",
              data: concertData,
              success: function (response) {
                console.log("Concert added:", response);
                // You can perform additional actions after the concert is added
              },
              error: function (xhr, status, error) {
                console.error("Error adding concert:", error);
                // Handle the error scenario if needed
              },
            });
          });
        }
        $("#logoutContainer").css({
          top: "10px",
          right: "10px",
        });
      });
    </script>
  </body>
</html>
